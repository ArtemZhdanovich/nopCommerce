function setMarkerAnimation(n,t){var i=$.grep(markers,function(t){if(t.shopId==n)return t});i!=null&&i.length>0&&i[0].setAnimation(t)}function getMarkersData(){var u=$(shopResourcesSelector).attr("data-markersdata"),t,n,i,r,f;if(u)for(t=JSON.parse(u),n=0;n<t.length;n++)(i=t[n].Latitude,r=t[n].Longitude,i!=null&&r!=null&&patternCoords.test(i)&&patternCoords.test(r))&&(f={id:t[n].Id,lat:i,lng:r,title:t[n].Name,shortdescription:t[n].ShortDescription},allShops[n]=f)}function getRemainingStoresList(){$.ajax({type:"GET",url:$(shopResourcesSelector).attr("data-getremainingshopsurl"),success:function(n){$(".shops-list").append(n)},error:function(){console.log("Failed to get remaining shops")}})}function loadMapScript(){var i=$(shopResourcesSelector).attr("data-googleapikey").trim(),n="https://maps.googleapis.com/maps/api/js?v=3.exp&libraries=places&callback=initializeMap",t;i&&(n=n+"&key="+i);t=document.createElement("script");t.src=n;document.body.appendChild(t)}function getCustomMapStyles(){var n=$(shopResourcesSelector).attr("data-mapstyles"),t="";if(!n)return"";try{t=JSON.parse(n)}catch(i){console.log("Invalid custom map styles value!")}return t}function initializeMap(){var n=document.getElementById(mapWrapperId),t={center:new google.maps.LatLng(shopX,shopY),mapTypeId:google.maps.MapTypeId.ROADMAP,zoom:parseInt($(shopResourcesSelector).attr("data-mapzoomlevel"))||15,styles:getCustomMapStyles()};map=new google.maps.Map(n,t);bounds=new google.maps.LatLngBounds;google.maps.event.addListenerOnce(map,"idle",function(){onMapLoad();createMapSearchBox()})}function onMapLoad(){var n,t;for(getMarkersData(),bounds=new google.maps.LatLngBounds,n=0;n<allShops.length;n++)allShops[n]!=null&&addMarker(allShops[n],!1);$(shopResourcesSelector).attr("data-manuallysetmapbounds")=="true"&&(t=new google.maps.LatLng($(shopResourcesSelector).attr("data-latitude"),$(shopResourcesSelector).attr("data-longitude")),bounds.extend(t));google.maps.event.addListenerOnce(map,"bounds_changed",function(){var n=parseInt($(shopResourcesSelector).attr("data-mapzoomlevel"))||15;this.setZoom(Math.min(n,this.getZoom()))});allShops.length>1&&map.fitBounds(bounds);markerCluster=new MarkerClusterer(map,markers,{imagePath:"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m"});directionsService=new google.maps.DirectionsService;directionsDisplay=new google.maps.DirectionsRenderer;directionsDisplay.setPanel(document.getElementById("directions-panel"));$(".getUserGeoLocation").on("click",function(n){n.preventDefault();getUserGeoLocation()})}function addMarker(n,t){var r=new google.maps.LatLng(n.lat,n.lng),i=new google.maps.Marker({position:r,title:n.title,draggable:t});$(shopResourcesSelector).attr("data-manuallysetmapbounds")!=="true"&&(bounds.extend(r),map.setCenter(r));i.setMap(map);i.shopId=n.id;markers.push(i);google.maps.event.addListener(i,"click",function(){var t=n.shortdescription,r=new google.maps.InfoWindow({maxWidth:400,content:"<h5>"+n.title+"<\/h5><div>"+t+"<\/div>"});r.open(map,i);$(".shops-list > li").removeClass("active");$('.shops-list > li[data-shopid="'+n.id+'"]').addClass("active")})}function showMarkers(n){markerCluster.clearMarkers();markerCluster.addMarkers(n);bounds=new google.maps.LatLngBounds;for(var t=0;t<n.length;t++)bounds.extend(n[t].position),map.setCenter(n[t].position);google.maps.event.addListenerOnce(map,"bounds_changed",function(){var n=parseInt($(shopResourcesSelector).attr("data-mapzoomlevel"))||15;this.setZoom(Math.min(n,this.getZoom()))});map.fitBounds(bounds)}function clearMapRoute(){directionsDisplay.setMap(null);$(".directions-wrapper, .map-wrapper, #backToResults").removeClass("directions-shown")}function createMapSearchBox(){var n=document.getElementById("shop-address-input"),t;map.controls[google.maps.ControlPosition.TOP_LEFT].push(n);t=new google.maps.places.SearchBox(n);n.style.display="block";google.maps.event.addListener(t,"places_changed",function(){var n=t.getPlaces();n.length!=0&&(clearMapRoute(),createUserMarker(n[0].geometry.location),userMarker.setPosition(n[0].geometry.location),map.setCenter(n[0].geometry.location),searchResultCoords=n[0].geometry.location,showDistancesFromShopsToUser())})}function createUserMarker(n){if(!isUserMarkerCreated){var i=$(shopResourcesSelector).attr("data-pathtoimages")+"/squat_marker_green_thumb.png",t=new google.maps.Marker({position:n,map:map,icon:i,animation:google.maps.Animation.DROP,title:$(shopResourcesSelector).attr("data-youarehere"),draggable:!0});t.setMap(map);userMarker=t;bounds.extend(n);$(".distanceAndDirections").show();$('#sortingSelect option[value="sortbydistance"]').removeAttr("disabled");isUserMarkerCreated=!0;google.maps.event.addListener(t,"dragend",function(){showMarkers(markers);$(".shops-list > li").show();showDistancesFromShopsToUser()})}}function getUserGeoLocation(n){var t="Geolocation is not supported by this browser.";return navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(i){if(t="Now we use your current position. ( Maybe a confirmation is required by the browser to use it. )",!isUserMarkerCreated||!n){var r=new google.maps.LatLng(i.coords.latitude,i.coords.longitude);createUserMarker(r);userMarker.setPosition(r);map.setCenter(r)}showDistancesFromShopsToUser();showDirectionsToShop(n)},function(t){if($(".getUserGeoLocation").hide(),$(".additional-info").text("User Geolocation denied. You should enable it from browser permissions settings. Setting the marker to default position..."),!isUserMarkerCreated||!n){var i=new google.maps.LatLng(map.center.lat(),map.center.lng());createUserMarker(i);userMarker.setPosition(i)}showDistancesFromShopsToUser();showDirectionsToShop(n);console.log(t)}),t}function showDirectionsToShop(n){var i,t,r,u;n&&((i=parseInt(n.closest("li.shops-item").attr("data-shopid")),t=$.grep(markers,function(n){if(n.shopId==i)return n})[0],i<0||t==null)||(r=$(shopResourcesSelector).attr("data-units")=="Imperial",u={origin:new google.maps.LatLng(userMarker.position.lat(),userMarker.position.lng()),destination:new google.maps.LatLng(t.position.lat(),t.position.lng()),travelMode:google.maps.TravelMode.DRIVING,unitSystem:r?google.maps.UnitSystem.IMPERIAL:google.maps.UnitSystem.METRIC},directionsService.route(u,function(n,t){t==google.maps.DirectionsStatus.OK&&(directionsDisplay.setMap(map),directionsDisplay.setDirections(n),$(".directions-wrapper, .all-shops-page .map-wrapper, #backToResults").addClass("directions-shown"))}),$("html, body").animate({scrollTop:$(".map-wrapper").offset().top-100},500)))}function showShopOnMap(n){if(n){var t=parseInt(n.closest("li.shops-item").attr("data-shopid")),i=$.grep(markers,function(n){if(n.shopId==t)return n})[0];t<0||i==null||(bounds=new google.maps.LatLngBounds,bounds.extend(i.position),google.maps.event.addListenerOnce(map,"bounds_changed",function(){this.setZoom(18)}),map.fitBounds(bounds),$("html, body").animate({scrollTop:$(".map-wrapper").offset().top-100},500))}}function showDistancesFromShopsToUser(){$(".shops-list > li").each(function(){var n=$(this),i=n.attr("data-shopid"),t=$.grep(markers,function(n){if(n.shopId==i)return n})[0];t!=null&&getDistanceToPosition(t.position,n)});$('#sortingSelect option[value="sortbydistance"]').attr("selected","selected");sortShopsByDistance()}function getDistanceToPosition(n,t){var s=$(shopResourcesSelector).attr("data-units")=="Imperial",r=Math.toRadians(userMarker.position.lat()),h=Math.toRadians(userMarker.position.lng()),u=Math.toRadians(n.lat()),c=Math.toRadians(n.lng()),f=u-r,e=c-h,o=Math.sin(f/2)*Math.sin(f/2)+Math.cos(r)*Math.cos(u)*Math.sin(e/2)*Math.sin(e/2),l=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o)),i=6371*l;s?(t.find(".distance-value").html(Math.round(i*.621371192)+" mi."),t.find(".distanceToShopValue").val(i*.621371192)):(t.find(".distance-value").html(Math.round(i)+" km."),t.find(".distanceToShopValue").val(i))}function sortShopsBySelectedMethod(){var n=$("#sortingSelect").val();n=="sortbydistance"?sortShopsByDistance():n=="sortbyname"?sortShopsByName():n=="sortbyid"&&sortShopsById()}function sortShopsByName(){var n=$(".shops-list > li");n.sort(function(n,t){var i=$(n).find(".shop-name").text().trim(),r=$(t).find(".shop-name").text().trim();return i.localeCompare(r)});$(".shops-list").html(n)}function sortShopsByDistance(){if(isUserMarkerCreated){var n=$(".shops-list > li");n.sort(function(n,t){var i=parseFloat($(n).find(".distanceToShopValue").val()),r=parseFloat($(t).find(".distanceToShopValue").val());return i-r});$(".shops-list").html(n)}}function sortShopsById(){var n=$(".shops-list > li");n.sort(function(n,t){var i=parseInt($(n).attr("data-shopid")),r=parseInt($(t).attr("data-shopid"));return i-r});$(".shops-list").html(n)}function searchForShopsMatchingTheSearchCriteria(){var t=isUserMarkerCreated,i=$("#searchByTagsInput").val(),r=i.length>2,u=parseFloat($("#searchRadius").val()),n;(isNaN(u)&&(t=!1),t||r)&&(n=[],$(".shops-list > li").each(function(){var f=$(this),l=parseInt(f.attr("data-shopid")),o=$.grep(markers,function(n){if(n.shopId==l)return n})[0],s=!0,h=!0,c,e;t&&(c=parseFloat(f.find(".distanceToShopValue").val()),c>u&&(s=!1));r&&(e=f.find(".shop-tags-hidden-field").val().toLowerCase(),(e==undefined||e.indexOf(i.toLowerCase())==-1)&&(h=!1));s&&h?(f.show(),o!=null&&n.push(o)):f.hide()}),n.lenght>0&&showMarkers(n),$(".shops-list > li:visible").length==0?$(".no-shops-after-filtering").show():$(".no-shops-after-filtering").hide(),sortShopsBySelectedMethod())}var mapWrapperId="all-shops-map-holder",shopResourcesSelector=".shop-resources",allShops=[],directionsService,directionsDisplay,map,markers=[],userMarker,bounds,markerCluster,searchResultCoords,shopX=0,shopY=0,patternCoords=new RegExp(/^-?\d+\.?\d*$/),isUserMarkerCreated=!1;$(window).load(function(){$(shopResourcesSelector).attr("data-shouldgetremainingshops")=="true"&&getRemainingStoresList()});$(document).ready(function(){if($(shopResourcesSelector).length>0&&document.getElementById(mapWrapperId)!=null){loadMapScript();$("#backToResults").on("click",function(){clearMapRoute()});$("#searchForFilteredShops").on("click",function(n){n.preventDefault();searchForShopsMatchingTheSearchCriteria();$("#clearShopFilters").css("display","inline-block")});$(".shops-list").on("click",".show-directions",function(n){n.preventDefault();getUserGeoLocation($(this))});$(".shops-list").on("click",".show-on-map",function(n){n.preventDefault();showShopOnMap($(this))});$(".shops-list").on("mouseenter","li",function(){var n=$(this).attr("data-shopid");setMarkerAnimation(n,google.maps.Animation.BOUNCE)}).on("mouseleave","li",function(){var n=$(this).attr("data-shopid");setMarkerAnimation(n,null)});$("#clearShopFilters").on("click",function(){showMarkers(markers);$(".shops-list > li").show();$("#searchByTagsInput").val("");$("#searchRadius").val("");$(this).hide();$(".shops-list > li:visible").length!==0&&$(".no-shops-after-filtering").hide()});$("#sortingSelect").on("change",sortShopsBySelectedMethod);$(".align-map-button").on("click",function(){map.fitBounds(bounds)})}});Math.toRadians=function(n){return n*Math.PI/180};