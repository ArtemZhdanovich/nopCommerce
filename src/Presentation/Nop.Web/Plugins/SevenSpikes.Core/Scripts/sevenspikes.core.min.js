(function ($, ssCore) {

    var isMenuInitialized = false;

    // needed for unsupported methods in some browsers i.e IE11
    (function () {
        // Compatibility fallback for "trim"
        if (typeof String.prototype.trim !== 'function') {
            String.prototype.trim = function () {
                return this.replace(/^\s+|\s+$/g, '');
            };
        }

        // Compatibility fallback for "startsWith"
        if (typeof String.prototype.startsWith !== 'function') {
            String.prototype.startsWith = function (needle) {
                return this.indexOf(needle) === 0;
            };
        }
    })();

    function isMobileDeviceInternal() {
        var isMobile = {
            Android: function () {
                return navigator.userAgent.match(/Android/i);
            },
            BlackBerry: function () {
                return navigator.userAgent.match(/BlackBerry/i);
            },
            iOS: function () {
                return navigator.userAgent.match(/iPhone|iPad|iPod/i);
            },
            Opera: function () {
                return navigator.userAgent.match(/Opera Mini/i);
            },
            Windows: function () {
                return navigator.userAgent.match(/IEMobile/i);
            },
            any: function () {
                return (this.Android() || this.BlackBerry() || this.iOS() || this.Opera() || this.Windows()) ? true : false;
            }
        };

        return isMobile.any();
    }

    ssCore.isInViewPort = function (element) {

        var elementTop = $(element).offset().top;
        var elementBottom = elementTop + $(element).outerHeight();

        var viewportTop = $(window).scrollTop();
        var viewportBottom = viewportTop + $(window).height();

        var isElementInViewPort = elementBottom > viewportTop && elementTop < (viewportBottom + 100);

        if (isElementInViewPort) {

            return $(element).is(':visible');
        }

        return isElementInViewPort;
    };

    ssCore.loadImagesOnScroll = function () {

        var windowObj = $(window);

        var lazyLoadImages = function () {

            $('img[data-lazyloadsrc]').not('[loadedimage]').each(function () {

                var that = $(this);

                /* 
                    * we do not lazy load images from JCarousel
                    * since they will be loaded by the slick slider 
                    */
                var isInJCarousel = that.parents()
                    .filter(function () {

                        return $(this).hasClass('jCarouselMainWrapper');
                    }).length > 0;

                if (isInJCarousel) {

                    return;
                }

                if (ssCore.isInViewPort(that)) {
                    that.attr('src', that.attr('data-lazyloadsrc'));

                    that.attr('loadedimage', 'true');
                }
            });
        };

        $(document).ready(function () {

            lazyLoadImages();

            windowObj.on('scroll.lazyLoadImages', lazyLoadImages);
        });

        $(document).on('nopAjaxFiltersFiltrationCompleteEvent nopAjaxCartProductAddedToCartEvent nopQuickViewDataShownEvent newProductsAddedToPageEvent', lazyLoadImages);
    };

    $.fn.extend({
        // custom select
        simpleSelect: function () {
            return this.each(function () {
                var that = $(this);

                if (that.parent().hasClass('select-wrap')) {
                    return;
                }

                that.wrap('<div class="select-wrap"></div>')
                    .after('<span class="select-box">' + '<span class="select-inner">' + that.find(':selected').text() + '</span>' + '</span>');

                that.change(function () {
                    that.next().children('.select-inner').text(that.find(':selected').text());
                });
            });
        }
    });

    // Properties
    ssCore.isRtl = $('#isRtlEnabled').val() === 'true';
    ssCore.isMobileDevice = isMobileDeviceInternal();
    ssCore.isMobile = isMobileDeviceInternal;

    // Methods
    ssCore.AntiSpam = function (emailName, emailDomain) {
        window.location.href = 'mailto:' + emailName + '@' + emailDomain;
    };

    ssCore.getAttrValFromDom = function (elementSelector, elementAttribute, defaultValue) {
        var value = $(elementSelector).attr(elementAttribute);

        if (value == undefined || value === '') {
            //if (window.console) {
            //    console.log('"' + elementAttribute + '" was not found.');
            //}

            if (defaultValue != undefined) {
                value = defaultValue;
            } else {
                value = '';
            }
        }

        return value;
    };

    ssCore.getHiddenValFromDom = function (elementSelector, defaultValue) {
        var value = $(elementSelector).val();

        if (value == undefined || value === '') {
            if (defaultValue != undefined) {
                value = defaultValue;
            } else {
                value = '';
            }
        }

        return value;
    };

    ssCore.getUrlVar = function (name) {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');

        for (var i = 0; i < hashes.length; i++) {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];

            if (name != null && hash[0] === name) {
                return hash[1];
            }
        }

        if (name != null) {
            return null;
        }

        return vars;
    };

    ssCore.getViewPort = function () {
        var e = window, a = 'inner';
        if (!('innerWidth' in window)) {
            a = 'client';
            e = document.documentElement || document.body;
        }

        var result = { width: e[a + 'Width'], height: e[a + 'Height'] };

        return result;
    };

    ssCore.prepareTopMenu = function () {
        var menuListItems = '.mega-menu li, .top-menu li';

        if (isMenuInitialized) {
            $('.menu-title').off('click.ssCore');
            $('.plus-button').off('click.ssCore');
            $(menuListItems).off('mouseenter.ssCore mouseleave.ssCore');

            $('.top-menu').removeAttr('style');
            $('.sublist-wrap.active').removeClass('active');
            $('.plus-button.close').removeClass('close');
            $('.menu-title.close').removeClass('close');
        }

        isMenuInitialized = true;

        var breakPointWidth = window.themeSettings && window.themeSettings['themeBreakpoint'] || 980;
        var isAccordionMenu = window.themeSettings && window.themeSettings['isAccordionMenu'] || false;

        var viewportWidth = ssCore.getViewPort().width;

        $('.menu-title').on('click.ssCore', function () {

            $(this).toggleClass('close', !$(this).hasClass('close'));

            $(this).siblings('.top-menu, .mega-menu-responsive').slideToggle('fast', function () {
                $(this).css('overflow', '');
            });

            if (!isAccordionMenu) {
                //adds the PERFECT SCROLL to the whole mobile menu
                $('.header-menu, .sublist-wrap').perfectScrollbar({
                    swipePropagation: false,
                    wheelSpeed: 1,
                    suppressScrollX: true
                });
            }
        });

        $('.plus-button').on('click.ssCore', function (e) {
            e.stopPropagation();

            var thisPlusButton = $(this);

            thisPlusButton.toggleClass('close', !thisPlusButton.hasClass('close'));

            var sublist = thisPlusButton.siblings('.sublist-wrap');

            if (sublist.hasClass('active')) {

                sublist.removeClass('active');
            } else {
                if (!isAccordionMenu) {

                    thisPlusButton.parents().eq(2).animate({ scrollTop: 0 }, 180, function () {
                        sublist.addClass('active');
                    });
                } else {
                    sublist.addClass('active');
                }
            }

            if (!isAccordionMenu) {
                //removes the PERFECT SCROLL when opening inner level and add again when closing it
                thisPlusButton.parents().eq(2).perfectScrollbar('destroy');
            }
        });

        if (viewportWidth > breakPointWidth) {

            $('.sublist-wrap.active').removeClass('active');
            $('.plus-button.close').removeClass('close');

            $(menuListItems).each(function () {

                var menuElement = $(this).parents('ul').last();
                var showDropdownsOnClick = menuElement.attr('data-enableClickForDropDown') === 'true';

                if (!showDropdownsOnClick) {
                    var mouseEnterTimeout, mouseLeaveTimeout;

                    $(this).on('mouseenter.ssCore', function () {
                        var that = $(this);
                        clearTimeout(mouseLeaveTimeout);
                        mouseEnterTimeout = setTimeout(function () {
                            $('a', that).first().addClass('hover');
                            $('.sublist-wrap, .dropdown', that).first().addClass('active');
                        }, 180);
                    }).on('mouseleave.ssCore', function () {
                        var that = $(this);
                        clearTimeout(mouseEnterTimeout);
                        mouseLeaveTimeout = setTimeout(function () {
                            $('a', that).first().removeClass('hover');
                            $('.sublist-wrap, .dropdown', that).first().removeClass('active');
                        }, 180);
                    });
                }
            });
        } else {

            $(menuListItems).off('mouseenter.ssCore mouseleave.ssCore');
            $('.sublist-wrap.active').removeClass('active');
            $('.plus-button.close').removeClass('close');
        }
    };

    ssCore.loadImagesOnScroll();
})(jQuery, window.sevenSpikesCore = window.sevenSpikesCore || {});